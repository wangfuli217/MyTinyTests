<head>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=04ecec4d88bce342a194b284491e5098"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=vkRFW7tPwUzAtZgfWG3XwG7tjI2TRDjm"></script>

</head>
<body>

<p id="result">result</p>
<p id="stops">stops</p>
<p id="path">path</p>

<script >

//定义一个自己的全局变量
var search_global = {};

//NOTE:输入参数, 目标城市
search_global.expect_city = '上海';
search_global.city_lines = ['20路', '791路']

//地图提供商的枚举
search_global.MapProvider = {
	AMap: 0,
	BaiduMap: 1,
	GoogleMap: 2
}
search_global.MapProviderName = ["AMap", "BaiduMap", "GoogleMap"];

//NOTE: options
search_global.options = {
	map_provider: search_global.MapProvider.AMap,				//选择地图提供商
	is_write_city_lines_to_file_after_place_search: true,		//选择基于城市的初步 PlaceSearch后的结果city_lines是否写入文件
	is_write_city_lines_to_file_after_nearby_search: true,		//选择迭代的 PlaceNearbySearch 后的结果city_lines是否写入文件
	is_search_via_exist_city_lines: (search_global.city_lines ? true : false)	//根据现有的city_lines进行LineSearch or 从PlaceSearch开始
}


//统计
search_global.searched_count = 0;

</script>

<!-- 公用功能 -->
<script src="my_base_tools.js"></script>
<script src="write_to_file.js"></script>

<!-- 引用AMAP功能 -->
<script src="place_search_amap.js"></script>
<script src="place_search_nearby_amap.js"></script>
<script src="lines_search_amap.js"></script>

<!-- 引用Baidu Map功能 -->
<script src="local_search_baidumap.js"></script>
<script src="busline_search_baidumap.js"></script>

<script >
search_global.placeSearchDone_Callback = function (city_lines_result, city_stations_result, city_stations_location_result)
{
	//console.log(city_lines_result);
	console.log("placeSearchDone_Callback, city_lines_result.length: " + city_lines_result.length + ", city_stations_result.length: " 
		+ city_stations_result.length + ", city_stations_location_result.length: " + city_stations_location_result.length);
	++search_global.searched_count;

	if (search_global.options.is_write_city_lines_to_file_after_place_search){
		//把city_lines写入文件
		write_city_lines_to_file(search_global.expect_city, "PlaceSearchCityLines", city_lines_result);
	}
	
	if (city_stations_location_result.length > 0){
			
		//deep copy
		var wait_for_nearby_search_locations = [];
		for (var i in city_stations_location_result){

			wait_for_nearby_search_locations.push(city_stations_location_result[i]);
		}
		var loc = wait_for_nearby_search_locations.pop();

		// 触发nearby搜索
		nearby_search_global_amap.executePlaceSearchNearbyForCity(search_global.placeNearbySearchDone_Callback, city_lines_result, city_stations_result, city_stations_location_result, search_global.expect_city, loc, wait_for_nearby_search_locations);
	}

}
search_global.placeNearbySearchDone_Callback = function (city_lines_result, city_stations_result, city_stations_location_result, wait_for_nearby_search_locations_result)
{
	console.log("placeNearbySearchDone_Callback, city_lines_result.length: " + city_lines_result.length 
		+ ", city_stations_result.length: " + city_stations_result.length 
		+ ", city_stations_location_result.length: " + city_stations_location_result.length
		+ ", wait_for_nearby_search_locations_result.length: " + wait_for_nearby_search_locations_result.length);
	document.getElementById('result').innerHTML = wait_for_nearby_search_locations_result.length;

	++search_global.searched_count;
	if (search_global.searched_count % 30 == 0){
		//try to avoid the AMAP human verification
		sleep(15 * 1000);
	}
	if (search_global.searched_count % 100 == 0){
		//NOTE: 过程中也把city_lines写入文件, 以免由于高德的拖动认证问题导致成果作废...
		write_city_lines_to_file(search_global.expect_city, "NearbySearchCityLines_temp_" + search_global.searched_count, out_str);
	}

	if (0 == wait_for_nearby_search_locations_result.length){

		if (search_global.options.is_write_city_lines_to_file_after_nearby_search){
			//把city_lines写入文件
			write_city_lines_to_file(search_global.expect_city, "NearbySearchCityLines", out_str);
		}
		
		// 触发Line搜索
		lines_search_global_amap.executeLineSearch(search_global.lineSearchDone_Callback, search_global.expect_city, city_lines_result);
	}else{
		var loc = wait_for_nearby_search_locations_result.pop();

		// 触发nearby搜索
		nearby_search_global_amap.executePlaceSearchNearbyForCity(search_global.placeNearbySearchDone_Callback, city_lines_result, city_stations_result, city_stations_location_result, search_global.expect_city, loc, wait_for_nearby_search_locations_result);
	}


}
search_global.lineSearchDone_Callback = function (out_str_result, map_provider_name)
{
	//console.log(out_str_result);
	console.log("out_str_result len: " + out_str_result.length);

	// 触发文件写入
	write_to_file(search_global.expect_city, "LinesDetails_" + map_provider_name, 
		out_str_result.replace(/<\/br>/g, "\n"));
}

//入口
if (search_global.options.map_provider === search_global.MapProvider.AMap){
	if (search_global.options.is_search_via_exist_city_lines){
		//已有线路list, 直接搜索线路详细
		lines_search_global_amap.executeLineSearch(search_global.lineSearchDone_Callback, 
			search_global.expect_city, search_global.city_lines);
	}else{
		//需要POI迭代搜索以尝试枚举
		place_search_global_amap.executePlaceSearchForCity(search_global.placeSearchDone_Callback, search_global.expect_city);
	}
}else if (search_global.options.map_provider === search_global.MapProvider.BaiduMap){
	//TODO: 
	//local_search_global_bmap.execute_local_search(search_global.expect_city, "公交");
	busline_search_global_bmap.execute_buslines_search(search_global.lineSearchDone_Callback, 
		search_global.expect_city, search_global.city_lines);

}else if (search_global.options.map_provider === search_global.MapProvider.GoogleMap){
	//TODO:
}
</script>

</body>