<head>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=04ecec4d88bce342a194b284491e5098"></script>

</head>
<body>

<p id="result">result</p>
<p id="stops">stops</p>
<p id="path">path</p>

<script >

//定义一个自己的全局变量
var search_global = {};

//NOTE:输入参数, 目标城市
search_global.expect_city = '上海';


//通用的error handler
function errorHandler(e) {

  console.log(e.name + ": " + e.message);
}

search_global.sleep = function (ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

search_global.searched_count = 0;

</script>
<script src="place_search_amap.js"></script>
<script src="place_search_nearby_amap.js"></script>
<script src="lines_search_amap.js"></script>
<script src="write_to_file.js"></script>

<script >
search_global.placeSearchDone_Callback = function (city_lines_result, city_stations_result, city_stations_location_result)
{
	//console.log(city_lines_result);
	console.log("placeSearchDone_Callback, city_lines_result.length: " + city_lines_result.length + ", city_stations_result.length: " 
		+ city_stations_result.length + ", city_stations_location_result.length: " + city_stations_location_result.length);
	++search_global.searched_count;
	
	if (city_stations_location_result.length > 0){
			
		//deep copy
		var wait_for_nearby_search_locations = [];
		for (var i in city_stations_location_result){

			wait_for_nearby_search_locations.push(city_stations_location_result[i]);
		}
		var loc = wait_for_nearby_search_locations.pop();

		// 触发nearby搜索
		executePlaceSearchNearbyForCity(search_global.placeNearbySearchDone_Callback, city_lines_result, city_stations_result, city_stations_location_result, search_global.expect_city, loc, wait_for_nearby_search_locations);
	}

}
search_global.placeNearbySearchDone_Callback = function (city_lines_result, city_stations_result, city_stations_location_result, wait_for_nearby_search_locations_result)
{
	console.log("placeNearbySearchDone_Callback, city_lines_result.length: " + city_lines_result.length 
		+ ", city_stations_result.length: " + city_stations_result.length 
		+ ", city_stations_location_result.length: " + city_stations_location_result.length
		+ ", wait_for_nearby_search_locations_result.length: " + wait_for_nearby_search_locations_result.length);
	document.getElementById('result').innerHTML = wait_for_nearby_search_locations_result.length;

	++search_global.searched_count;
	if (search_global.searched_count % 30 == 0){
		//try to avoid the AMAP human verification
		search_global.sleep(15 * 1000);
	}

	if (0 == wait_for_nearby_search_locations_result.length){
		
		// 触发Line搜索
		executeLineSearch(search_global.lineSearchDone_Callback, search_global.expect_city, city_lines_result);
	}else{
		var loc = wait_for_nearby_search_locations_result.pop();

		// 触发nearby搜索
		executePlaceSearchNearbyForCity(search_global.placeNearbySearchDone_Callback, city_lines_result, city_stations_result, city_stations_location_result, search_global.expect_city, loc, wait_for_nearby_search_locations_result);
	}


}
search_global.lineSearchDone_Callback = function (out_str_result)
{
	//console.log(out_str_result);
	console.log("out_str_result len: " + out_str_result.length);

	// 触发文件写入
	write_to_file(search_global.expect_city, out_str_result);
}

//入口
executePlaceSearchForCity(search_global.placeSearchDone_Callback, search_global.expect_city);
</script>

</body>